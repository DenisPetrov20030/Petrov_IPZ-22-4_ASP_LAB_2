@page "/login"
@inject AuthService AuthService
@inject NavigationManager NavigationManager

<PageTitle>Вхід - Hospital System</PageTitle>

<div class="container py-5">
	<div class="row justify-content-center">
		<div class="col-md-6 col-lg-5">
			<div class="card shadow">
				<div class="card-header bg-primary text-white">
					<h4 class="mb-0"><i class="bi bi-box-arrow-in-right"></i> Вхід до системи</h4>
				</div>
				<div class="card-body">
					@if (!string.IsNullOrEmpty(errorMessage))
					{
						<div class="alert alert-danger alert-dismissible fade show" role="alert">
							<i class="bi bi-exclamation-triangle"></i> @errorMessage
							<button type="button" class="btn-close" @onclick="@(() => errorMessage = null)"></button>
						</div>
					}

					<EditForm Model="@loginModel" OnValidSubmit="@HandleLogin">
						<DataAnnotationsValidator />
						<ValidationSummary class="text-danger" />

						<div class="mb-3">
							<label for="username" class="form-label">Email або ім'я користувача</label>
							<InputText id="username" @bind-Value="loginModel.UserName" class="form-control" placeholder="example@email.com" />
							<ValidationMessage For="@(() => loginModel.UserName)" />
						</div>

						<div class="mb-3">
							<label for="password" class="form-label">Пароль</label>
							<InputText id="password" type="password" @bind-Value="loginModel.Password" class="form-control" placeholder="Пароль" />
							<ValidationMessage For="@(() => loginModel.Password)" />
						</div>

						<div class="d-grid gap-2">
							<button type="submit" class="btn btn-primary" disabled="@isLoading">
								@if (isLoading)
								{
									<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
									<span>Завантаження...</span>
								}
								else
								{
									<span><i class="bi bi-box-arrow-in-right"></i> Увійти</span>
								}
							</button>
						</div>
					</EditForm>

					<hr class="my-4" />

					<div class="text-center">
						<p class="mb-0">Немає акаунту? <a href="/register">Зареєструватись</a></p>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

@code {
	private LoginDto loginModel = new();
	private string? errorMessage;
	private bool isLoading = false;

	private async Task HandleLogin()
	{
		isLoading = true;
		errorMessage = null;

		try
		{
			var result = await AuthService.LoginAsync(loginModel);
			if (result != null)
			{
				NavigationManager.NavigateTo("/", true);
			}
			else
			{
				errorMessage = "Невірний email або пароль";
			}
		}
		catch (Exception ex)
		{
			errorMessage = $"Помилка входу: {ex.Message}";
		}
		finally
		{
			isLoading = false;
		}
	}
}
