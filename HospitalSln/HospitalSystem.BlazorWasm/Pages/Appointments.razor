@page "/appointments"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject AppointmentService AppointmentService
@inject NavigationManager NavigationManager

<PageTitle>Записи на прийом - Hospital System</PageTitle>

<div class="container py-4">
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h2 class="mb-0">
			@if (string.IsNullOrEmpty(selectedDepartment))
			{
				<span>Всі записи на прийом</span>
			}
			else
			{
				<span>Відділення: @selectedDepartment</span>
			}
		</h2>
		<a href="/appointments/create" class="btn btn-primary">
			<i class="bi bi-plus-circle"></i> Новий запис
		</a>
	</div>

	<div class="row mb-3">
		<div class="col-md-4">
			<label for="departmentFilter" class="form-label">Фільтр за відділенням</label>
			<select id="departmentFilter" class="form-select" @onchange="OnDepartmentChanged">
				<option value="">Всі відділення</option>
				@if (departments != null)
				{
					@foreach (var dept in departments)
					{
						<option value="@dept" selected="@(dept == selectedDepartment)">@dept</option>
					}
				}
			</select>
		</div>
	</div>

	@if (isLoading)
	{
		<div class="text-center py-5">
			<div class="spinner-border text-primary" role="status">
				<span class="visually-hidden">Завантаження...</span>
			</div>
			<p class="mt-2">Завантаження записів...</p>
		</div>
	}
	else if (errorMessage != null)
	{
		<div class="alert alert-danger" role="alert">
			<i class="bi bi-exclamation-triangle"></i> @errorMessage
		</div>
	}
	else if (appointments == null || !appointments.Any())
	{
		<div class="alert alert-info text-center" role="alert">
			<i class="bi bi-info-circle"></i> Немає записів на прийом
		</div>
	}
	else
	{
		<div class="table-responsive">
			<table class="table table-hover align-middle">
				<thead class="table-light">
					<tr>
						<th>Пацієнт</th>
						<th>Лікар</th>
						<th>Дата та час</th>
						<th>Відділення</th>
						<th>Дії</th>
					</tr>
				</thead>
				<tbody>
					@foreach (var appointment in appointments)
					{
						<tr>
							<td>@appointment.PatientName</td>
							<td>@appointment.DoctorName</td>
							<td>@appointment.AppointmentDate.ToString("dd.MM.yyyy HH:mm")</td>
							<td><span class="badge bg-info">@appointment.Department</span></td>
							<td>
								<a href="/appointments/details/@appointment.AppointmentID" class="btn btn-sm btn-outline-primary me-1">
									<i class="bi bi-eye"></i> Деталі
								</a>
								<a href="/appointments/edit/@appointment.AppointmentID" class="btn btn-sm btn-outline-warning me-1">
									<i class="bi bi-pencil"></i> Редагувати
								</a>
								<a href="/appointments/delete/@appointment.AppointmentID" class="btn btn-sm btn-outline-danger">
									<i class="bi bi-trash"></i> Видалити
								</a>
							</td>
						</tr>
					}
				</tbody>
			</table>
		</div>

		@if (totalPages > 1)
		{
			<nav aria-label="Page navigation">
				<ul class="pagination justify-content-center">
					@for (int i = 1; i <= totalPages; i++)
					{
						var pageNumber = i;
						<li class="page-item @(i == currentPage ? "active" : "")">
							<button class="page-link" @onclick="@(() => LoadAppointments(pageNumber))">@i</button>
						</li>
					}
				</ul>
			</nav>
		}
	}
</div>

@code {
	private List<Appointment>? appointments;
	private List<string>? departments;
	private string? selectedDepartment;
	private string? errorMessage;
	private bool isLoading = true;
	private int currentPage = 1;
	private int pageSize = 10;
	private int totalPages = 1;

	protected override async Task OnInitializedAsync()
	{
		await LoadDepartments();
		await LoadAppointments();
	}

	private async Task LoadDepartments()
	{
		departments = await AppointmentService.GetDepartmentsAsync();
	}

	private async Task LoadAppointments(int page = 1)
	{
		isLoading = true;
		errorMessage = null;
		currentPage = page;

		try
		{
			var response = await AppointmentService.GetAppointmentsAsync(selectedDepartment, page, pageSize);
			if (response != null)
			{
				appointments = response.Data;
				totalPages = response.TotalPages;
			}
			else
			{
				errorMessage = "Помилка завантаження записів";
			}
		}
		catch (Exception ex)
		{
			errorMessage = $"Помилка: {ex.Message}";
		}
		finally
		{
			isLoading = false;
		}
	}

	private async Task OnDepartmentChanged(ChangeEventArgs e)
	{
		selectedDepartment = e.Value?.ToString();
		if (string.IsNullOrEmpty(selectedDepartment))
			selectedDepartment = null;
		await LoadAppointments();
	}
}
