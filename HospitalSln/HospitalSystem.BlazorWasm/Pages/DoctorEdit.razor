@page "/doctors/edit/{id:long}"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@inject DoctorService DoctorService
@inject NavigationManager NavigationManager

<PageTitle>Редагувати лікаря - Hospital System</PageTitle>

<div class="container py-4">
	@if (isLoading)
	{
		<div class="text-center py-5">
			<div class="spinner-border text-primary" role="status">
				<span class="visually-hidden">Завантаження...</span>
			</div>
		</div>
	}
	else if (doctor == null)
	{
		<div class="alert alert-danger" role="alert">
			<i class="bi bi-exclamation-triangle"></i> Лікаря не знайдено
		</div>
	}
	else
	{
		<div class="card shadow">
			<div class="card-header bg-warning">
				<h4 class="mb-0"><i class="bi bi-pencil"></i> Редагування лікаря</h4>
			</div>
			<div class="card-body">
				@if (!string.IsNullOrEmpty(errorMessage))
				{
					<div class="alert alert-danger alert-dismissible fade show" role="alert">
						<i class="bi bi-exclamation-triangle"></i> @errorMessage
						<button type="button" class="btn-close" @onclick="@(() => errorMessage = null)"></button>
					</div>
				}

				<EditForm Model="@doctor" OnValidSubmit="@HandleSubmit">
					<DataAnnotationsValidator />
					<ValidationSummary class="text-danger" />

					<div class="mb-3">
						<label for="fullName" class="form-label">Повне ім'я *</label>
						<InputText id="fullName" @bind-Value="doctor.FullName" class="form-control" />
						<ValidationMessage For="@(() => doctor.FullName)" />
					</div>

					<div class="mb-3">
						<label for="specialization" class="form-label">Спеціалізація *</label>
						<InputText id="specialization" @bind-Value="doctor.Specialization" class="form-control" />
						<ValidationMessage For="@(() => doctor.Specialization)" />
					</div>

					<div class="mb-3">
						<label for="department" class="form-label">Відділення *</label>
						<InputText id="department" @bind-Value="doctor.Department" class="form-control" />
						<ValidationMessage For="@(() => doctor.Department)" />
					</div>

					<div class="mb-3">
						<label for="phoneNumber" class="form-label">Номер телефону *</label>
						<InputText id="phoneNumber" @bind-Value="doctor.PhoneNumber" class="form-control" />
						<ValidationMessage For="@(() => doctor.PhoneNumber)" />
					</div>

					<div class="mb-3">
						<label for="email" class="form-label">Електронна пошта *</label>
						<InputText id="email" @bind-Value="doctor.Email" class="form-control" type="email" />
						<ValidationMessage For="@(() => doctor.Email)" />
					</div>

					<div class="d-flex justify-content-between">
						<div>
							<button type="submit" class="btn btn-warning" disabled="@isSaving">
								@if (isSaving)
								{
									<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
									<span>Збереження...</span>
								}
								else
								{
									<span><i class="bi bi-save"></i> Оновити</span>
								}
							</button>
						</div>
						<a href="/doctors" class="btn btn-outline-secondary">
							<i class="bi bi-x-circle"></i> Скасувати
						</a>
					</div>
				</EditForm>
			</div>
		</div>
	}
</div>

@code {
	[Parameter]
	public long Id { get; set; }

	private Doctor? doctor;
	private string? errorMessage;
	private bool isLoading = true;
	private bool isSaving = false;

	protected override async Task OnInitializedAsync()
	{
		await LoadDoctor();
	}

	private async Task LoadDoctor()
	{
		isLoading = true;
		try
		{
			doctor = await DoctorService.GetDoctorByIdAsync(Id);
		}
		catch (Exception ex)
		{
			errorMessage = $"Помилка завантаження: {ex.Message}";
		}
		finally
		{
			isLoading = false;
		}
	}

	private async Task HandleSubmit()
	{
		if (doctor == null) return;

		isSaving = true;
		errorMessage = null;

		try
		{
			var success = await DoctorService.UpdateDoctorAsync(Id, doctor);
			if (success)
			{
				NavigationManager.NavigateTo("/doctors");
			}
			else
			{
				errorMessage = "Помилка оновлення лікаря. Перевірте дані та спробуйте ще раз.";
			}
		}
		catch (Exception ex)
		{
			errorMessage = $"Помилка: {ex.Message}";
		}
		finally
		{
			isSaving = false;
		}
	}
}
