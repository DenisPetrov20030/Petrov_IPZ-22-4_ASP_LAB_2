@page "/appointments/delete/{id:long}"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject AppointmentService AppointmentService
@inject NavigationManager NavigationManager

<PageTitle>Видалити запис - Hospital System</PageTitle>

<div class="container py-4">
	@if (isLoading)
	{
		<div class="text-center py-5">
			<div class="spinner-border text-primary" role="status">
				<span class="visually-hidden">Завантаження...</span>
			</div>
		</div>
	}
	else if (appointment == null)
	{
		<div class="alert alert-danger" role="alert">
			<i class="bi bi-exclamation-triangle"></i> Запис не знайдено
		</div>
	}
	else
	{
		<div class="card shadow border-danger">
			<div class="card-header bg-danger text-white">
				<h4 class="mb-0"><i class="bi bi-trash"></i> Видалення запису</h4>
			</div>
			<div class="card-body">
				<div class="alert alert-warning" role="alert">
					<i class="bi bi-exclamation-triangle"></i>
					<strong>Увага!</strong> Ви збираєтесь видалити цей запис. Цю дію неможливо скасувати.
				</div>

				@if (!string.IsNullOrEmpty(errorMessage))
				{
					<div class="alert alert-danger alert-dismissible fade show" role="alert">
						<i class="bi bi-exclamation-triangle"></i> @errorMessage
						<button type="button" class="btn-close" @onclick="@(() => errorMessage = null)"></button>
					</div>
				}

				<dl class="row">
					<dt class="col-sm-4">Пацієнт:</dt>
					<dd class="col-sm-8">@appointment.PatientName</dd>

					<dt class="col-sm-4">Лікар:</dt>
					<dd class="col-sm-8">@appointment.DoctorName</dd>

					<dt class="col-sm-4">Дата і час:</dt>
					<dd class="col-sm-8">@appointment.AppointmentDate.ToString("dd.MM.yyyy HH:mm")</dd>

					<dt class="col-sm-4">Відділення:</dt>
					<dd class="col-sm-8">@appointment.Department</dd>
				</dl>

				<div class="d-flex justify-content-between mt-4">
					<button class="btn btn-danger" @onclick="HandleDelete" disabled="@isDeleting">
						@if (isDeleting)
						{
							<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
							<span>Видалення...</span>
						}
						else
						{
							<span><i class="bi bi-trash"></i> Підтвердити видалення</span>
						}
					</button>
					<a href="/appointments" class="btn btn-outline-secondary">
						<i class="bi bi-x-circle"></i> Скасувати
					</a>
				</div>
			</div>
		</div>
	}
</div>

@code {
	[Parameter]
	public long Id { get; set; }

	private Appointment? appointment;
	private string? errorMessage;
	private bool isLoading = true;
	private bool isDeleting = false;

	protected override async Task OnInitializedAsync()
	{
		isLoading = true;
		try
		{
			appointment = await AppointmentService.GetAppointmentByIdAsync(Id);
		}
		catch (Exception ex)
		{
			errorMessage = $"Помилка завантаження: {ex.Message}";
		}
		finally
		{
			isLoading = false;
		}
	}

	private async Task HandleDelete()
	{
		isDeleting = true;
		errorMessage = null;

		try
		{
			var success = await AppointmentService.DeleteAppointmentAsync(Id);
			if (success)
			{
				NavigationManager.NavigateTo("/appointments");
			}
			else
			{
				errorMessage = "Помилка видалення запису. Спробуйте ще раз.";
			}
		}
		catch (Exception ex)
		{
			errorMessage = $"Помилка: {ex.Message}";
		}
		finally
		{
			isDeleting = false;
		}
	}
}
