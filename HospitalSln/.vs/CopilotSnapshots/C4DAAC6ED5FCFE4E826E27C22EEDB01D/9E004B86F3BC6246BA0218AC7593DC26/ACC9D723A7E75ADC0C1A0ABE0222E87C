using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.IdentityModel.Tokens;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;

namespace HospitalSystem.API.Controllers
{
	[Route("api/[controller]")]
	[ApiController]
	public class AuthController : ControllerBase
	{
		private readonly UserManager<IdentityUser> _userManager;
		private readonly SignInManager<IdentityUser> _signInManager;
		private readonly RoleManager<IdentityRole> _roleManager;

		public AuthController(
			UserManager<IdentityUser> userManager,
			SignInManager<IdentityUser> signInManager,
			RoleManager<IdentityRole> roleManager)
		{
			_userManager = userManager;
			_signInManager = signInManager;
			_roleManager = roleManager;
		}

		[HttpPost("register")]
		public async Task<IActionResult> Register([FromBody] RegisterDto model)
		{
			if (model.Role != "Patient" && model.Role != "Doctor")
			{
				return BadRequest(new { message = "Invalid role. Choose Patient or Doctor." });
			}

			var user = new IdentityUser
			{
				UserName = model.UserName,
				Email = model.Email
			};

			var result = await _userManager.CreateAsync(user, model.Password);

			if (result.Succeeded)
			{
				if (!await _roleManager.RoleExistsAsync(model.Role))
				{
					await _roleManager.CreateAsync(new IdentityRole(model.Role));
				}

				await _userManager.AddToRoleAsync(user, model.Role);

				return Ok(new { message = $"User registered successfully as {model.Role}" });
			}

			return BadRequest(result.Errors);
		}

		[HttpPost("login")]
		public async Task<IActionResult> Login([FromBody] LoginDto model)
		{
			var user = await _userManager.FindByNameAsync(model.UserName);

			if (user == null)
			{
				user = await _userManager.FindByEmailAsync(model.UserName);
			}

			if (user != null)
			{
				var result = await _signInManager.CheckPasswordSignInAsync(user, model.Password, false);

				if (result.Succeeded)
				{
					var roles = await _userManager.GetRolesAsync(user);
					var token = GenerateJwtToken(user, roles);

					return Ok(new
					{
						token,
						userName = user.UserName,
						email = user.Email,
						roles
					});
				}
			}

			return Unauthorized(new { message = "Invalid username or password" });
		}

		private string GenerateJwtToken(IdentityUser user, IList<string> roles)
		{
			var claims = new List<Claim>
			{
				new Claim(ClaimTypes.Name, user.UserName!),
				new Claim(ClaimTypes.Email, user.Email!),
				new Claim(ClaimTypes.NameIdentifier, user.Id)
			};

			foreach (var role in roles)
			{
				claims.Add(new Claim(ClaimTypes.Role, role));
			}

			var key = new SymmetricSecurityKey(Encoding.ASCII.GetBytes("YourSuperSecretKeyHere12345678901234567890"));
			var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

			var token = new JwtSecurityToken(
				claims: claims,
				expires: DateTime.Now.AddHours(3),
				signingCredentials: creds
			);

			return new JwtSecurityTokenHandler().WriteToken(token);
		}
	}

	public class RegisterDto
	{
		public string UserName { get; set; } = string.Empty;
		public string Email { get; set; } = string.Empty;
		public string Password { get; set; } = string.Empty;
		public string Role { get; set; } = "Patient";
	}

	public class LoginDto
	{
		public string UserName { get; set; } = string.Empty;
		public string Password { get; set; } = string.Empty;
	}
}
