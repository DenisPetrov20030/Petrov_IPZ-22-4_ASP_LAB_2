# SignalR Real-Time Appointment Updates

## Опис функціональності

В проект HospitalSystem було інтегровано SignalR для реалізації оновлень доступних годин візиту в реальному часі.

## Що було додано

### 1. **AppointmentHub** (`HospitalSystem/Hubs/AppointmentHub.cs`)
SignalR Hub, який керує real-time повідомленнями про зміни в записах:
- `NotifyAppointmentCreated` - сповіщення про створення нового запису
- `NotifyAppointmentUpdated` - сповіщення про оновлення запису
- `NotifyAppointmentDeleted` - сповіщення про скасування/видалення запису

### 2. **Оновлений AppointmentsController**
Контролер тепер використовує `IHubContext<AppointmentHub>` для відправки real-time повідомлень:
- При створенні запису (POST Create) - всі клієнти отримують повідомлення про новий запис
- При оновленні запису (POST Edit) - всі клієнти отримують повідомлення про зміни
- При видаленні запису (POST Delete) - всі клієнти отримують повідомлення про вільний час

### 3. **Клієнтський JavaScript** (`HospitalSystem/wwwroot/js/appointment-signalr.js`)
JavaScript код, який:
- Підключається до SignalR Hub
- Автоматично перепідключається при розриві з'єднання
- Слухає події створення, оновлення та видалення записів
- Відображає toast-повідомлення про зміни
- Автоматично оновлює сторінку для відображення актуальних даних

### 4. **Оновлений Layout** (`HospitalSystem/Views/Shared/_Layout.cshtml`)
В layout додано:
- Підключення SignalR клієнтської бібліотеки з CDN
- Підключення custom JavaScript файлу з логікою SignalR (тільки для автентифікованих користувачів)

### 5. **Оновлений _AppointmentRow.cshtml**
Додано `data-appointment-id` атрибут для можливості динамічного видалення рядків таблиці при отриманні події видалення.

## Як це працює

### Сценарій 1: Створення нового запису
1. Користувач А відкриває сторінку `/Appointments`
2. Користувач Б створює новий запис на `/Appointments/Create`
3. Сервер зберігає запис та відправляє SignalR повідомлення всім підключеним клієнтам
4. Користувач А бачить toast-повідомлення "Новий запис створено: ..."
5. Через 2 секунди сторінка автоматично оновлюється, показуючи новий запис

### Сценарій 2: Оновлення запису
1. Користувач А переглядає список записів
2. Користувач Б редагує запис (змінює час або іншу інформацію)
3. Всі користувачі отримують повідомлення про зміни
4. Сторінка автоматично оновлюється для відображення актуальних даних

### Сценарій 3: Скасування запису (видалення)
1. Користувач А переглядає список записів
2. Користувач Б видаляє запис (лікар скасовує прийом)
3. Всі користувачі отримують повідомлення "Запис скасовано: [Лікар] на [Час] тепер вільний"
4. Рядок з таблиці підсвічується червоним і видаляється
5. Через 2 секунди сторінка оновлюється

## Технічні деталі

### Конфігурація в Program.cs
```csharp
builder.Services.AddSignalR();
// ...
app.MapHub<AppointmentHub>("/appointmentHub");
```

### Dependency Injection в Controller
```csharp
private readonly IHubContext<AppointmentHub> _hubContext;

public AppointmentsController(IHospitalRepository repo, IHubContext<AppointmentHub> hubContext)
{
    repository = repo;
    _hubContext = hubContext;
}
```

### Відправка повідомлень
```csharp
await _hubContext.Clients.All.SendAsync("AppointmentCreated", new
{
    appointmentId = appointment.AppointmentID,
    patientName = appointment.PatientName,
    doctorName = appointment.DoctorName,
    appointmentDate = appointment.AppointmentDate,
    department = appointment.Department,
    message = $"Новий запис створено: ..."
});
```

### Клієнтське підключення
```javascript
const connection = new signalR.HubConnectionBuilder()
    .withUrl("/appointmentHub")
    .withAutomaticReconnect()
    .build();
```

## Переваги реалізації

1. **Real-Time Updates** - Користувачі миттєво бачать зміни без необхідності оновлення сторінки
2. **Automatic Reconnection** - SignalR автоматично перепідключається при втраті з'єднання
3. **User-Friendly Notifications** - Красиві Bootstrap toast-повідомлення інформують про зміни
4. **Efficient Updates** - Сторінка оновлюється автоматично тільки при необхідності
5. **Broadcast to All** - Всі підключені користувачі отримують оновлення одночасно

## Можливості для розширення

1. **Групи за відділеннями** - Можна створити групи SignalR для кожного відділення, щоб користувачі отримували тільки релевантні повідомлення
2. **Персоналізовані повідомлення** - Відправка різних повідомлень пацієнтам та лікарям
3. **Історія змін** - Збереження та відображення історії всіх змін записів
4. **Inline Updates** - Оновлення даних в таблиці без перезавантаження сторінки
5. **Notifications Hub** - Окремий hub для інших типів сповіщень (нагадування, підтвердження і т.д.)

## Тестування

1. Відкрийте два браузери (або два вікна в режимі інкогніто)
2. Увійдіть в систему в обох вікнах
3. В одному вікні перейдіть на `/Appointments`
4. В іншому вікні створіть новий запис
5. Перше вікно має показати toast-повідомлення та автоматично оновитися

## Примітки

- SignalR працює тільки для автентифікованих користувачів
- Використовується CDN для SignalR клієнтської бібліотеки (версія 8.0.0)
- Toast-повідомлення автоматично зникають через 5 секунд
- Підключення автоматично відновлюється при проблемах з мережею
